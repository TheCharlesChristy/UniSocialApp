<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dynamic Comments</title>
    <link rel="stylesheet" href="css/globals.css">
    <link rel="stylesheet" href="css/post_container.css">
    <link rel="stylesheet" href="css/post_stats.css">
    <link rel="stylesheet" href="css/comment_view.css">
    <link rel="stylesheet" href="css/add_comment.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .test-description {
            color: #666;
            margin-bottom: 20px;
        }
        .simulate-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .simulate-btn:hover {
            background: #0056b3;
        }
        .demo-post {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        .comments-list {
            min-height: 50px;
            padding: 10px;
            background: #fafafa;
            border-top: 1px solid #eee;
        }
        .comment-container {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #007bff;
        }
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .comment-avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .username {
            font-weight: bold;
            color: #333;
        }
        .comment-time {
            color: #666;
            font-size: 12px;
            margin-left: 10px;
        }
        .comment-text {
            margin: 8px 0;
            color: #333;
        }
        .comment-actions {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        .comment-like-button, .comment-reply-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .comment-like-button:hover, .comment-reply-button:hover {
            color: #007bff;
        }
        .post-stats {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }
        .add-comment-section {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }
        .comment-form {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .comment-textarea {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            resize: vertical;
            min-height: 60px;
        }
        .submit-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .submit-btn:hover {
            background: #0056b3;
        }
        .reply-comment {
            margin-left: 30px;
            border-left-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-title">Dynamic Comments Test</div>
        <div class="test-description">
            This page tests the dynamic comment insertion functionality. 
            You can simulate adding comments and replies to see if they appear without page refresh.
        </div>
        
        <button class="simulate-btn" onclick="simulateTopLevelComment()">Simulate Top-Level Comment</button>
        <button class="simulate-btn" onclick="simulateReplyComment()">Simulate Reply Comment</button>
        <button class="simulate-btn" onclick="clearComments()">Clear Comments</button>
    </div>

    <div class="demo-post">
        <!-- Mock Post Stats -->
        <div class="post-stats" data-post-id="test-post-123">
            <div class="stat-item">
                <span>‚ù§Ô∏è</span>
                <span id="like-count-test-post-123">15</span>
            </div>
            <div class="stat-item">
                <span>üí¨</span>
                <span id="comment-count-test-post-123">3</span>
            </div>
            <div class="stat-item">
                <span>üìÖ</span>
                <span>2 hours ago</span>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-list" data-post-id="test-post-123">
            <!-- Existing comment for testing -->
            <div class="comment-container" data-comment-id="existing-comment-1" data-post-id="test-post-123">
                <div class="comment-header">
                    <div class="comment-avatar">
                        <img src="assets/images/default-profile.svg" alt="John's profile">
                    </div>
                    <div class="comment-user-info">
                        <span class="username">John Doe</span>
                        <span class="comment-time">1 hour ago</span>
                    </div>
                </div>
                <div class="comment-content">
                    <p class="comment-text">This is an existing comment to test dynamic insertion.</p>
                </div>
                <div class="comment-actions">
                    <button class="comment-like-button" data-comment-id="existing-comment-1">
                        ‚ù§Ô∏è <span id="comment-like-count-existing-comment-1">2</span>
                    </button>
                    <button class="comment-reply-button" onclick="showReplyForm('existing-comment-1')">
                        ‚Ü©Ô∏è Reply
                    </button>
                </div>
                <div class="children-comments">
                    <!-- Child comments will appear here -->
                </div>
            </div>
        </div>

        <!-- Add Comment Section -->
        <div class="add-comment-section">
            <div class="comment-form">
                <textarea class="comment-textarea" placeholder="Write a comment..." id="test-comment-input"></textarea>
                <button class="submit-btn" onclick="submitTestComment()">Post</button>
            </div>
        </div>
    </div>

    <!-- Include the JavaScript files -->
    <script src="js/generic-api.js"></script>
    <script src="js/post_stats.js"></script>
    <script src="js/comment_view.js"></script>
    <script src="js/add_comment.js"></script>

    <script>
        // Test simulation functions
        let commentCounter = 1;
        let replyCounter = 1;

        function simulateTopLevelComment() {
            const postId = 'test-post-123';
            const commentId = `test-comment-${commentCounter++}`;
            
            // Create mock comment data
            const mockComment = {
                id: commentId,
                content: `This is a dynamically added test comment #${commentCounter - 1}`,
                user_id: 'test-user',
                user_name: 'Test User',
                user_profile_picture_url: 'assets/images/default-profile.svg',
                parent_comment_id: null,
                created_at: new Date().toISOString(),
                likes_count: 0,
                has_liked: 0
            };

            // Dispatch the commentAdded event
            const event = new CustomEvent('commentAdded', {
                detail: { 
                    postId: postId, 
                    comment: mockComment
                }
            });
            document.dispatchEvent(event);

            console.log('Dispatched commentAdded event for top-level comment:', mockComment);
        }

        function simulateReplyComment() {
            const postId = 'test-post-123';
            const parentCommentId = 'existing-comment-1';
            const replyId = `test-reply-${replyCounter++}`;
            
            // Create mock reply data
            const mockReply = {
                id: replyId,
                content: `This is a dynamically added reply #${replyCounter - 1}`,
                user_id: 'test-user',
                user_name: 'Test User',
                user_profile_picture_url: 'assets/images/default-profile.svg',
                parent_comment_id: parentCommentId,
                created_at: new Date().toISOString(),
                likes_count: 0,
                has_liked: 0
            };

            // Dispatch the commentAdded event
            const event = new CustomEvent('commentAdded', {
                detail: { 
                    postId: postId, 
                    comment: mockReply
                }
            });
            document.dispatchEvent(event);

            console.log('Dispatched commentAdded event for reply comment:', mockReply);
        }

        function submitTestComment() {
            const textarea = document.getElementById('test-comment-input');
            const content = textarea.value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            const postId = 'test-post-123';
            const commentId = `manual-comment-${Date.now()}`;
            
            // Create mock comment data from user input
            const mockComment = {
                id: commentId,
                content: content,
                user_id: 'test-user',
                user_name: 'You',
                user_profile_picture_url: 'assets/images/default-profile.svg',
                parent_comment_id: null,
                created_at: new Date().toISOString(),
                likes_count: 0,
                has_liked: 0
            };

            // Clear the textarea
            textarea.value = '';

            // Dispatch the commentAdded event
            const event = new CustomEvent('commentAdded', {
                detail: { 
                    postId: postId, 
                    comment: mockComment
                }
            });
            document.dispatchEvent(event);

            console.log('Dispatched commentAdded event for manual comment:', mockComment);
        }

        function clearComments() {
            const commentsContainer = document.querySelector('.comments-list[data-post-id="test-post-123"]');
            if (commentsContainer) {
                // Remove all dynamically added comments, keep the existing one
                const dynamicComments = commentsContainer.querySelectorAll('[data-comment-id^="test-"], [data-comment-id^="manual-"]');
                dynamicComments.forEach(comment => comment.remove());
                
                // Reset comment counter in the stats
                const commentCountElement = document.getElementById('comment-count-test-post-123');
                if (commentCountElement) {
                    commentCountElement.textContent = '3'; // Reset to original count
                }
            }
            
            // Reset counters
            commentCounter = 1;
            replyCounter = 1;
            
            console.log('Cleared dynamic comments');
        }

        function showReplyForm(commentId) {
            alert(`Reply form for comment ${commentId} would be shown here in the real implementation`);
        }

        // Log when the page is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dynamic Comments Test Page Loaded');
            console.log('JavaScript files should be loaded and event listeners should be active');
            
            // Test if the functions are available
            if (typeof window.updateCommentCount === 'function') {
                console.log('‚úÖ updateCommentCount function is available');
            } else {
                console.log('‚ùå updateCommentCount function is not available');
            }
            
            if (typeof window.addCommentToDOM === 'function') {
                console.log('‚úÖ addCommentToDOM function is available');
            } else {
                console.log('‚ùå addCommentToDOM function is not available - this is expected as it\'s not a global function');
            }
        });
    </script>
</body>
</html>
